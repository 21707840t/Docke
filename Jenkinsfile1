node{
    
    
    stage('clone'){
        
        
        git credentialsId: 'id_gitlab', url: 'git@gitlab.com:khlifidev1/projet_j2e.git'
        
       
    }
    
    stage('Build'){
        
        withEnv(["JAVA_HOME=${ tool 'java' }", "PATH+MAVEN=${tool 'maven'}/bin:${env.JAVA_HOME}/bin"]) {
            
            sh 'mvn clean install package'
            
        }
        
        
    }
    
    
    stage('Deploy'){
sshPublisher(publishers: [sshPublisherDesc(configName: 'serveur docker', transfers: [sshTransfer(cleanRemote: false, excludes: '', execCommand: '', execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: '[, ]+', remoteDirectory: '', remoteDirectorySDF: false, removePrefix: 'webapp/target/', sourceFiles: 'webapp/target/webapp.war'), sshTransfer(cleanRemote: false, excludes: '', execCommand: '''docker rmi myapp;
docker rm -f webapp;
docker build -t myapp .;
docker run -d --name webapp -p 8050:8080 myapp''', execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: '[, ]+', remoteDirectory: '', remoteDirectorySDF: false, removePrefix: '', sourceFiles: 'Dockerfile')], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])
    }

}
